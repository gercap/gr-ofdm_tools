<!DOCTYPE html5>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Web SDR</title>

  <!-- CSS  
  <link href="static/fonts/fonts.fnt" rel="stylesheet">
  <link href="static/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="static/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  -->
  <!-- jquery  -->
  <script type="text/javascript" src="static/js/canvasjs.min.js"></script>
  <script type="text/javascript" src="static/jquery/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="static/js/Chart.bundle.min.js"></script>

<style>
* {
    box-sizing: border-box;
}

.column {
    float: left;
}

/* Clearfix (clear floats) */
.row::after {
    content: "";
    clear: both;
    display: table;
}
</style>

</head>

<script language="javascript" type="text/javascript">

  setInterval(timer_hour, 1000);
  function timer_hour() {
      var d = new Date();
      $("#head_datetime").html("{{description}} " + d.toLocaleTimeString()) ;
  }

  function linspacer(startValue, stopValue, cardinality, multiplier, adder) {
    var arr = [];
    var currValue = startValue;
    var step = (stopValue - startValue) / (cardinality - 1);
    for (var i = 0; i < cardinality; i++) {
      arr.push(Math.round((currValue + (step * i)) * multiplier + adder));
    }
    return arr;
  }

  function map (num, in_min, in_max, out_min, out_max) {
    return (num - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
  }

  // Returns a single rgb color interpolation between given rgb color
  // based on the factor given; via https://codepen.io/njmcode/pen/axoyD?editors=0010
  function interpolateColor(color1, color2, factor) {
      if (arguments.length < 3) { 
          factor = 0.5; 
      }
      var result = color1.slice();
      for (var i = 0; i < 3; i++) {
          result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
      }
      return "rgb("+result[0].toString() + "," + result[1].toString() + "," + result[2].toString() + ")";
  };
  // My function to interpolate between two colors completely, returning an array
  function interpolateColors(color1, color2, steps) {
      var stepFactor = 1 / (steps - 1),
          interpolatedColorArray = [];

      color1 = color1.match(/\d+/g).map(Number);
      color2 = color2.match(/\d+/g).map(Number);

      for(var i = 0; i < steps; i++) {
          interpolatedColorArray.push(interpolateColor(color1, color2, stepFactor * i));
      }
      return interpolatedColorArray;
  }

  var colorArray = interpolateColors("rgb(0, 0, 0)", "rgb(255, 255, 255)", 256);

  var samp_rate = 0;
  var tune_freq = 0;
  var precision = true;
  var rate = 0;
  var average = 0;
  var rf_gain = 0;
  var sel_freq = 0;

  var arrayBuffer;
  var fileReader = new FileReader();
  fileReader.onload = function(event) {
      arrayBuffer = event.target.result;
  };

  function init()
  {
    var host = window.location.hostname;
    var port = window.location.port;
    websocket_url_control = "{{scheme}}://" + host + ":9000/ws";
    websocket_url_data = "{{scheme}}://" + host + ":8000/ws";
    //initialize_canvasJS();
    //initialize_chartJS();
    init_fft_plot();
    init_water_plot()
  }
  function doConnect_control()
  {
    //control
    websocket_control = new WebSocket(websocket_url_control);
    websocket_control.onopen = function(evt) {onOpen_control(evt, websocket_url_control) };
    websocket_control.onclose = function(evt) {onClose_control(evt, websocket_url_control) };
    websocket_control.onmessage = function(evt) {onMessage_control(evt, websocket_url_control) };
    websocket_control.onerror = function(evt) {onError_control(evt, websocket_url_control) };
  }
  function doConnect_data()
  {
    //data
    websocket_data = new WebSocket(websocket_url_data);
    websocket_data.onopen = function(evt) {onOpen_data(evt, websocket_url_data) };
    websocket_data.onclose = function(evt) {onClose_data(evt, websocket_url_data) };
    websocket_data.onmessage = function(evt) {onMessage_data(evt, websocket_url_data) };
    websocket_data.onerror = function(evt) {onError_data(evt, websocket_url_data) };
  }
  function onOpen_control(evt, link)
  {
    var d = new Date();
    writeToScreen(d.toLocaleTimeString() + " " + link + " control connected\n");
  }
  function onOpen_data(evt, link)
  {
    var d = new Date();
    writeToScreen(d.toLocaleTimeString() + " " + link + " data connected\n");
  }
  function onClose_control(evt, link)
  {
    var d = new Date();
    writeToScreen(d.toLocaleTimeString() + " " + link + " control disc. reconnecting\n");
    setTimeout(doConnect_control, 3000);
  }
  function onClose_data(evt, link)
  {
    var d = new Date();
    writeToScreen(d.toLocaleTimeString() + " " + link + " data disc. reconnecting\n");
    setTimeout(doConnect_data, 3000);
  }
  function onMessage_control(evt, link)
  {
    var _data = JSON.parse(evt.data);
    if ("tune_freq" in _data) {
      tune_freq = _data["tune_freq"];
      writeToScreen("tune_freq: " + tune_freq + '\n');
      document.getElementById("freq").value = tune_freq;
    }
    else if ("samp_rate" in _data) {
      samp_rate = _data["samp_rate"];
      writeToScreen("samp_rate: " + samp_rate + '\n');
    }
    else if ("precision" in _data) {
      precision = _data["precision"];
      writeToScreen("precision: " + precision + '\n');
      if (precision == true){
        document.getElementById("precision").checked = true;
      } else {
        document.getElementById("precision").checked = false;
      }
    }
    else if ("rate" in _data) {
      rate = _data["rate"];
      writeToScreen("rate: " + rate + '\n');
      document.getElementById("rate").value = rate;
       document.getElementById("rate_val").innerHTML = "Rate " + rate + " (FFT/s)"; 
    }
    else if ("average" in _data) {
      average = _data["average"];
      writeToScreen("average: " + average + '\n');
      document.getElementById("average").value = average;
       document.getElementById("average_val").innerHTML = "Average " + average;
    }
    else if ("rf_gain" in _data) {
      rf_gain = _data["rf_gain"];
      writeToScreen("rf_gain: " + rf_gain + '\n');
      document.getElementById("rf_gain").value = rf_gain;
       document.getElementById("rf_gain_val").innerHTML = "RF Gain " + rf_gain;

    }
    else {
      writeToScreen("response: " + evt.data + '\n');      
    }
  }
  function onMessage_data(evt, link)
  {
    fileReader.readAsArrayBuffer(evt.data);
    
    if (precision) {
      var floatbyteArray = new Float32Array(arrayBuffer);
      plot_fft_data(floatbyteArray);
      plot_water_data(floatbyteArray);
    } else {
      var intbyteArray = new Int8Array(arrayBuffer);
      plot_fft_data(intbyteArray);
      plot_water_data(intbyteArray);
    }
    
  }
  function initialize_canvasJS()
  {
    canvasJSchart = new CanvasJS.Chart("canvasJScanvas", {
      axisX: {
        title: "Freq"
      },
      axisY: {
        title: "Amplitude"
      },
      data: [{
        type: "spline",
        name: "{{description}}",
        showInLegend: false,
        dataPoints: []
      }]
    });    
  }
  function draw_canvasJS(fft_data)
  {
    var axis = linspacer(-1, 1, fft_data.length, samp_rate/2.0, tune_freq)
    var max = Math.max.apply(Math, fft_data) + 1
    var min = Math.min.apply(Math, fft_data)
    var dps = []; //dataPoints. 

    for (var i = 0; i < fft_data.length; i++)
      dps.push({
        y: fft_data[i], label: axis[i]
      });

    canvasJSchart.options.data[0].dataPoints = dps;
    canvasJSchart.options.axisY.maximum = max;
    canvasJSchart.options.axisY.minimum = min;
    canvasJSchart.render();
    canvasJSchart.destroy();
    //canvasJSchart = null;
    //dps = null;
  }
  function initialize_chartJS()
  {
    var ctx = document.getElementById("chartJScanvas").getContext('2d');
    chartJSchart = new Chart(ctx, {
        type: 'line',
        fill: false,
        data: {
            labels: [],
            datasets: [{
                label: 'FFT',
                data: [],
                borderColor: 'rgba(0,0,255,0.3)',
            }]
        },
        options: {
            animation: false,
            elements: {
                line: {
                  fill: false
                },
                point: {
                  radius: 0 }
            }
        }
    });
  }
  function draw_chartJS(fft_data)
  { 
    var axis = linspacer(-1, 1, fft_data.length, samp_rate/2.0, tune_freq)
    chartJSchart.data = {
            labels: axis,
            datasets: [{
                label: 'FFT',
                data: fft_data,
                borderColor: 'rgba(0,0,255,0.3)',
            }]
        }
    chartJSchart.update();
  }
  function init_fft_plot()
  {    
    canvas_plot = document.getElementById("canvas_plot");
    context_plot = canvas_plot.getContext("2d");

    canvas_yScale = document.getElementById("canvas_yScale");
    context_yScale = canvas_yScale.getContext("2d");

    canvas_selection = document.getElementById("canvas_selection");
    context_selection = canvas_selection.getContext("2d");

    elemLeft = canvas_selection.offsetLeft;
    elemTop = canvas_selection.offsetTop;

    sel_line = 0;

    // Add event listener for `click` events.
    canvas_selection.addEventListener('click', function(event) {
      sel_line = event.pageX - elemLeft;
      var y = event.pageY - elemTop;

      var axis = linspacer(-1, 1, canvas_selection.width, samp_rate/2.0, tune_freq);
      sel_freq = axis[sel_line];
      writeToScreen("center/select: " + tune_freq + "/" + sel_freq +"\n");

    }, false);

    gradient = context_plot.createLinearGradient(0, 0, 0, -200);
    gradient.addColorStop("0","yellow");
    gradient.addColorStop("0.5","blue");
    gradient.addColorStop("1.0","green");

    context_yScale.strokeStyle="#001";
  }

  function plot_fft_data(dataSet) {

    Val_max = Math.max.apply(Math, dataSet);
    Val_min = Math.min.apply(Math, dataSet);

    var yScale = (canvas_plot.height) / (Val_max - Val_min);
    var xScale = (canvas_plot.width) / dataSet.length;

    //----------------y scale and selection-----------------------------
    canvas_selection.width = window.innerWidth - 30;
    canvas_selection.height = window.innerHeight - 400;

    canvas_yScale.width = window.innerWidth - 30;
    canvas_yScale.height = window.innerHeight - 400;
    context_yScale.rect(0, 0, canvas_yScale.width, canvas_yScale.height);

    for (y=5; y<=canvas_yScale.height; y+=20) {
      //console.log(y)
      context_yScale.fillText(Math.round((((y - 0) * (Val_max - Val_min)) / canvas_yScale.height) + Val_min), 5, canvas_yScale.height-y);
      context_yScale.moveTo(5, canvas_yScale.height-y);
      context_yScale.lineTo(canvas_yScale.width, canvas_yScale.height-y);
    }

    context_yScale.moveTo(canvas_yScale.width/2, 0);
    context_yScale.lineTo(canvas_yScale.width/2, canvas_yScale.height);

    context_yScale.moveTo(sel_line, 0);
    if (sel_line<canvas_yScale.width/2) {
      context_yScale.fillText(sel_freq, sel_line, 15);
    } else {
      context_yScale.fillText(sel_freq, sel_line-50, 15);
    }
    context_yScale.lineTo(sel_line, canvas_yScale.height);

    context_yScale.stroke();

    //----------------plot-------------------------------
    canvas_plot.width = window.innerWidth - 30;
    canvas_plot.height = window.innerHeight - 400;
    water_div.style.top = canvas_plot.height + 10

    context_plot.setTransform(1, 0, 0, 1, 0, 0); //reset translation
    context_plot.translate(0, canvas_plot.height + Val_min * yScale);
    context_plot.scale(1, -1 * yScale);

    context_plot.strokeStyle=gradient

    context_plot.beginPath();

    for (i=0;i<dataSet.length;i++) {
      //line connecting values
      //context_plot.lineTo(i * xScale, dataSet[i]);
      //or - bars from min to value
      context_plot.moveTo(i * xScale, Val_min);
      context_plot.lineTo(i * xScale, dataSet[i]);
    }

    //context_plot.rect(0, Val_max, canvas_plot.width, Val_min - Val_max);
    context_plot.stroke();
    context_plot.closePath();
  }
  function update_plot_stuff()
  {
    gradient=context_plot.createLinearGradient(0, Val_max, 0, Val_min);
    gradient.addColorStop("0","red");
    gradient.addColorStop("0.4","yellow");
    gradient.addColorStop("0.8","blue");
    gradient.addColorStop("1.0","green");
  }
  setInterval(update_plot_stuff, 1000);

  function init_water_plot()
  {    
    water_div = document.getElementById("water_div");

    canvas_water = document.getElementById("canvas_water");
    context_water = canvas_water.getContext("2d");

  }
  function plot_water_data(dataSet) {

    var xScale = (canvas_plot.width) / dataSet.length;

    //----------------plot-------------------------------
    water_div.style.top = window.innerHeight - 400 + 10
    canvas_water.width = canvas_plot.width

    context_water.setTransform(1, 0, 0, 1, 0, 0); //reset translation
    //context_water.translate(0, canvas_plot.height + Val_min * yScale);
    //context_water.scale(1, -1 * yScale);

    context_water.beginPath();

    console.log(colorArray[128])

    for (i=0;i<dataSet.length;i++) {
      amp = Math.round(map(dataSet[i], Val_min, Val_max, 0, 255))
      context_water.strokeStyle=colorArray[amp]
      context_water.moveTo(i * xScale, 50);
      context_water.lineTo(i * xScale, 150);
    }

    //context_water.rect(0, Val_max, canvas_plot.width, Val_min - Val_max);
    context_water.stroke();
    context_water.closePath();
  }

  function onError_control(evt, data)
  {
    writeToScreen('error control: ' + link + " " + evt.data + '\n');
    websocket_control.close();
  }
  function onError_data(evt, data)
  {
    writeToScreen('error data: ' + link + " " + evt.data + '\n');
    websocket_data.close();
  }
  function doSend(message)
  {
    writeToScreen("sent: " + message + '\n'); 
    websocket_control.send(message);
  }
  function writeToScreen(message)
  {
    document.infoform.outputtext.value += message
	  document.infoform.outputtext.scrollTop = document.infoform.outputtext.scrollHeight;
  }
  window.addEventListener("load", init, false);
   function sendText() {
		doSend("hi");
   }
  function clearText() {
		document.infoform.outputtext.value = "";
   }
  function doDisconnect() {
    websocket_control.close();
  }

  function set_precision() {
      var checkBox = document.getElementById("precision");
      if (checkBox.checked == true){
          $.post('/set_precision', {precision: "True"}, function() {});
      } else {
          $.post('/set_precision', {precision: "False"}, function() {});
      }
  }
  function set_average(newaverage){
    $.post('/set_average', {average: newaverage}, function() {});
  }
  function set_rate(newrate){
    $.post('/set_rate', {rate: newrate}, function() {});
  }
  function set_freq(newfreq){
    $.post('/set_tune_freq', {freq: newfreq}, function() {});
  }
  function set_rf_gain(newrf_gain){
    $.post('/set_rf_gain', {rf_gain: newrf_gain}, function() {});
  }
</script>

<body onload="doConnect_control(); doConnect_data()">

<div >
   <h5 id = "head_datetime" class="header center col s12 light">{{description}} {{now}})</br>
</div>

<div class="display: table;">
  <div style="display: table-row">
    <div style="width: 600px; display: table-cell;">
      <input type="checkbox" id="precision" checked="checked" onclick="set_precision()">
      <label for="precision">High (32bit) precision</label>
    </div>
    <div style="width: 600px; display: table-cell;">
       <label id = "average_val" for="average">Average</label>
       <input type="range" id="average" min="0.01" max="0.99" step=".01" oninput="set_average(this.value)" onchange="set_average(this.value)">
    </div>
    <div style="width: 600px; display: table-cell;">
     <label id = "freq_val" for="freq">Freq [Hz]</label>
     <input id="freq" type="number" value="000000000" onchange="set_freq(this.value)">
    </div>
  </div>
  <div style="display: table-row">
    <div style="width: 600px; display: table-cell;">
     <label id = "rate_val" for="rate">Rate (FFT/s)</label>
     <input type="range" id="rate" min="1" max="25" step="1" value="2" oninput="set_rate(this.value)" onchange="set_rate(this.value)">
    </div> 
    <div style="width: 600px; display: table-cell;">
     <label id = "rf_gain_val" for="rf_gain">Rx Gain</label>
     <input type="range" id="rf_gain" min="0" max="50" step="1" value="15" oninput="set_rf_gain(this.value)" onchange="set_rf_gain(this.value)">
    </div>

    <div style="width: 600px; display: table-cell;">
      <form name="infoform">
          <textarea name="outputtext" rows="2" cols="30"></textarea>
      </form>
    </div> 

  </div>

</div>

<div style="position: relative;">
 <canvas id="canvas_yScale" width="100" height="100" 
   style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
 <canvas id="canvas_plot" width="100" height="100" 
   style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
 <canvas id="canvas_selection" width="100" height="100" 
   style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>
</div>

<div id="water_div" style="position: relative; left: 0; top: 400; z-index: 0;">
 <canvas id="canvas_water" style="height: 200px; width: 100%;"></canvas>
</div> 

<!--
<div id="canvasJScanvas" style="height: 600px; width: 100%;"></div>
<canvas id="chartJScanvas" style="height: 600px; width: 100%;"></canvas>
-->

</body>

</html>